---
title: "Master"
author: "Juan Felipe Padilla SepÃºlveda"
date: "`r Sys.Date()`"
mainfont: Charter
fontsize: 11pt
output: 
  pdf_document:
    latex_engine: xelatex
  html_document:
    keep_md: yes
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  comment = "#>",
  collapse = TRUE,
  fig.width = 6,
  fig.asp = 0.618,
  out.width = "70%",
  fig.align = "center",
  fig.show = "hold"
)

# Library calls
pacman::p_load(
  tidyverse,
  magrittr,
  stringr,
  readr,
  quantmod,
  mice,
  VIM,
  urca
)
```

# Preliminary

```{bash dta2csv, eval = FALSE}
# Convert the database of U.S. Call Reports from .dta to .csv

Rscript ./R/dta2csv.R
```

```{bash xlsx2csv, eval = FALSE}
# Convert the database of uncertainty indexes of JLN from .xlsx to .csv

Rscript ./R/xlsx2csv.R
```

# Import databases

## U.S. Call Reports

```{r call.reports.usa}
call.reports.usa <- read_csv(
  "./Data/CallReportsUSA.csv",
  col_names = c(
    "BankID",
    "Date",
    "Name",
    "TotalAssets",
    "RealStateLoans",
    "PersonalLoans",
    "AgriculturalLoans",
    "TotalEquity",
    "CILoans",
    "TotalLoans",
    "Securities",
    "TotalLiabilities"
  ),
  col_types = str_c(c("f", rep("c", 2), rep("d", 9)), collapse = ""),
  skip = 1,
  n_max = 1609540
)
```

## Uncertainty indexes

```{r financial.uncertainty.JLN}
financial.uncertainty.JLN <- read_csv(
  "./Data/FinancialUncertaintyJLN.csv",
  col_names = c("Date", paste0("FU-JLN-h", c(1, 3, 12))),
  col_types = str_c(c("?", rep("d", 3)), collapse = ""),
  skip = 1,
  n_max = 702
)
```

```{r macro.uncertainty.JLN}
macro.uncertainty.JLN <- read_csv(
  "./Data/MacroUncertaintyJLN.csv",
  col_names = c("Date", paste0("MU-JLN-h", c(1, 3, 12))),
  col_types = str_c(c("?", rep("d", 3)), collapse = ""),
  skip = 1,
  n_max = 702
)
```

## Factors of FED data

```{r factors.FED}
factors.FED <- read_csv(
  "./Matlab/FactorsFED.csv",
  col_names = c(paste0(rep("Factor", 7), 1:7)),
  col_types = str_c(rep("d", 7), collapse = ""),
  skip = 0,
  n_max = 725
)
```

# Clean U.S. Call Reports database

## Resize the database for to allow two business cycles or more for each bank

The average length of the business cycle is retrieved from NBER for the period 1945-2009: 69.5 months (trought from previous trought).

```{r business.cycles}
call.reports.usa %<>%
  semi_join(
    call.reports.usa %>%
      count(BankID) %>%
      filter(n > 47)
  )
```

## Missing data

### Identifying missing values

```{r is.na}
sum(is.na(call.reports.usa[["CILoans"]]))

mean(is.na(call.reports.usa[["CILoans"]]))

mean(!complete.cases(call.reports.usa))
```

### Exploring missing-values patterns

```{r md.pattern, fig.asp = 1}
md.pattern(call.reports.usa, rotate.names = TRUE)
```

### Exploring missing data visually

```{r aggr}
aggr(call.reports.usa, prop = FALSE, numbers = TRUE)
```

### Delete missing values because the hardware requirements for carry on multiple imputation are too high

```{r anti_join}
call.reports.usa %<>%
  anti_join(
    call.reports.usa %>%
      filter(is.na(CILoans)) %>%
      count(BankID)
  )
```

# Change format of date column

```{r yearmon}
call.reports.usa %<>% mutate(Date = as.yearmon(Date, "%Y%m%d"))

financial.uncertainty.JLN %<>% mutate(Date = as.yearmon(Date, "%Y-%m-%d"))

macro.uncertainty.JLN %<>% mutate(Date = as.yearmon(Date, "%Y-%m-%d"))

factors.FED %<>% # Dates go from 1959:01 to 2019:07
  mutate(Date = yearmon(seq(1959 + 2 / 12, 2019 + 6 / 12, 1 / 12))) %>%
  select(Date, everything())
```

# Merge the databases

```{r left_join}
call.reports.usa %<>%
  left_join(financial.uncertainty.JLN) %>%
  left_join(macro.uncertainty.JLN) %>%
  left_join(factors.FED)
```

# Eliminate the individual databases

```{r rm}
rm(financial.uncertainty.JLN, macro.uncertainty.JLN, factors.FED)
```

# Growth rate

## Replace the zeros in the commercial and industrial loans for minimum value in the sample (1)

```{r zeros.ciloans}
call.reports.usa %<>% mutate(CILoans = ifelse(near(CILoans, 0), 1, CILoans))
```

## Growth rates of commercial and industrial loans for each bank

```{r growth.rate.loans}
call.reports.usa %<>%
  group_by(BankID) %>%
  mutate(
    growth.rate.ciloans = 100 * (CILoans - lag(CILoans)) / lag(CILoans),
    # growth.rate.ciloans = ifelse(
    #  is.nan(growth.rate.ciloans),
    #  0,
    #  growth.rate.ciloans
    # ),
    # growth.rate.ciloans = ifelse(
    #  near(growth.rate.ciloans, -1),
    #  -100,
    #  growth.rate.ciloans
    # ),
    growth.rate.ciloans.annualized = 12 * growth.rate.ciloans
  )
```

# The DF-GLS test for a unit root

```{r}
call.reports.usa %>%
  filter(BankID == 37) %$%
  ur.ers(
    CILoans
  )
```

