---
title: "Master"
author: "Juan Felipe Padilla SepÃºlveda"
date: "`r Sys.Date()`"
mainfont: Charter
fontsize: 11pt
output: 
  pdf_document:
    latex_engine: xelatex
  html_document:
    keep_md: yes
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  comment = "#>",
  collapse = TRUE,
  fig.width = 6,
  fig.asp = 0.618,
  out.width = "70%",
  fig.align = "center",
  fig.show = "hold",
  tidy = "styler"
)

# Library calls
pacman::p_load(
  tidymodels,
  magrittr,
  tidyr,
  readr,
  stringr,
  lubridate,
  ggthemes,
  VIM,
  urca
)

# Set seed of random number generator
set.seed(1112494378)

# Set theme of ggplot
theme_set(theme_tufte())
```

# Preliminary

```{bash dta2csv, eval = FALSE}
# Convert the database of U.S. Call Reports from .dta to .csv

Rscript ./R/dta2csv.R
```

```{bash xlsx2csv, eval = FALSE}
# Convert the database of uncertainty indexes of JLN from .xlsx to .csv

Rscript ./R/xlsx2csv.R
```

# Import databases

## U.S. Call Reports

```{r call.reports.usa}
call.reports.usa <- read_csv(
  "./Data/CallReportsUSA.csv",
  col_names = c(
    "BankID",
    "Date",
    "Name",
    "TotalAssets",
    "RealStateLoans",
    "PersonalLoans",
    "AgriculturalLoans",
    "TotalEquity",
    "CILoans",
    "TotalLoans",
    "Securities",
    "TotalLiabilities"
  ),
  col_types = str_c(c("f", rep("c", 2), rep("d", 9)), collapse = ""),
  skip = 1,
  n_max = 1609540
)
```

## Uncertainty indexes

```{r financial.uncertainty.JLN}
financial.uncertainty.JLN <- read_csv(
  "./Data/FinancialUncertaintyJLN.csv",
  col_names = c("Date", paste0("FU_JLN_h", c(1, 3, 12))),
  col_types = str_c(c("?", rep("d", 3)), collapse = ""),
  skip = 1,
  n_max = 702
)
```

```{r macro.uncertainty.JLN}
macro.uncertainty.JLN <- read_csv(
  "./Data/MacroUncertaintyJLN.csv",
  col_names = c("Date", paste0("MU_JLN_h", c(1, 3, 12))),
  col_types = str_c(c("?", rep("d", 3)), collapse = ""),
  skip = 1,
  n_max = 702
)
```

## Factors of FED data

```{r factors.FED}
factors.FED <- read_csv(
  "./Matlab/FactorsFED.csv",
  col_names = c(paste0(rep("Factor", 7), 1:7)),
  col_types = str_c(rep("d", 7), collapse = ""),
  skip = 0,
  n_max = 725
)
```

# Clean U.S. Call Reports database

## Resize the database for to allow two business cycles or more for each bank

The average length of the business cycle is retrieved from NBER for the period 1945-2009: 69.5 months (trought from previous trought).

```{r business.cycles}
call.reports.usa %<>%
  semi_join(
    call.reports.usa %>%
      count(BankID) %>%
      filter(n > 47),
    by = "BankID"
  )
```

## Missing data

### Identifying missing values

```{r is.na}
sum(is.na(call.reports.usa[["CILoans"]]))

mean(is.na(call.reports.usa[["CILoans"]]))

mean(!complete.cases(call.reports.usa))
```

### Exploring missing data visually

```{r aggr}
aggr(call.reports.usa, prop = FALSE, numbers = TRUE)
```

### Delete missing values (listwise deletion) because the hardware requirements for carry on multiple imputation are too high

```{r anti_join}
call.reports.usa %<>%
  anti_join(
    call.reports.usa %>%
      filter(is.na(CILoans)) %>%
      count(BankID), 
    by = "BankID"
  )
```

# Change format of date column

```{r yearmon}
call.reports.usa %<>% mutate(Date = ymd(Date))

financial.uncertainty.JLN %<>% 
  mutate(Date = seq(ymd(19600801), ymd(20190101), by = "1 month") - 1)

macro.uncertainty.JLN %<>%
  mutate(Date = seq(ymd(19600801), ymd(20190101), by = "1 month") - 1)

factors.FED %<>% 
  mutate(Date = seq(ymd(19590401), ymd(20190801), by = "1 month") - 1) %>% 
  select(Date, everything())
```

# Merge the databases

```{r left_join}
call.reports.usa %<>% list(
  financial.uncertainty.JLN,
  macro.uncertainty.JLN,
  factors.FED
) %>% 
  reduce(left_join)
```

# Eliminate the individual databases

```{r rm}
rm(financial.uncertainty.JLN, macro.uncertainty.JLN, factors.FED)
```

# Growth rate

## Replace the zeros in the commercial and industrial loans for minimum value in the sample: one unit

```{r zeros.ciloans}
call.reports.usa %<>% mutate(CILoans = ifelse(near(CILoans, 0), 1, CILoans))
```

## Growth rates of commercial and industrial loans for each bank

```{r growth.rate.loans}
call.reports.usa %<>%
  group_by(BankID) %>%
  mutate(
    growth.rate.ciloans = 100 * (CILoans - lag(CILoans)) / lag(CILoans),
    # growth.rate.ciloans = ifelse(
    #  is.nan(growth.rate.ciloans),
    #  0,
    #  growth.rate.ciloans
    # ),
    # growth.rate.ciloans = ifelse(
    #  near(growth.rate.ciloans, -1),
    #  -100,
    #  growth.rate.ciloans
    # ),
    growth.rate.ciloans.annualized = 4 * growth.rate.ciloans
  )
```

# Train and test split

```{r initial_split}
train.test.split <- initial_split(call.reports.usa, prop = 0.80)

call.reports.usa.train <- training(train.test.split)

call.reports.usa.test <- testing(train.test.split)
```

# Nested tibble

```{r nest}
call.reports.usa.train %<>% nest()
```

## Fit many models

```{r Macro_h1}
call.reports.usa.train %<>% mutate(
  Macro_h1 = map(
    data,
    ~lm(
      growth.rate.ciloans ~ MU_JLN_h1 +
        Factor1 + Factor2 + Factor3 + Factor4 + Factor5 + Factor6 + Factor7,
      .
    )
  )
)
```

## Model quality

```{r glance}
model.quality <- call.reports.usa.train %>% 
  mutate(Quality = map(model, glance)) %>% 
  unnest(Quality)
```

# Tidy model

```{r}
call.reports.usa.train %<>% mutate(Coeff = map(Macro_h1, tidy)) 
```

# 

```{r}
coeff <- call.reports.usa.train %>% 
  unnest(Coeff) %>% 
  filter(term == "MU_JLN_h1") %>% 
  select(estimate:p.value)

coeff %>% 
  ggplot(aes(estimate)) +
    geom_histogram(bins = 180) +
    coord_cartesian(ylim = c(0, 50)) +
    labs(
      x = quote(beta[Uncertainty]),
      y = "Count",
      title = "Distribution of the effect of macroeconomic uncertainty (h = 1)",
      caption = "Data from U.S. Call Reports, FRED-MD and Jurado et al. (2015)"
    )
ggsave("MU_JLN_h1.pdf")
```

# The DF-GLS test for a unit root

```{r}
call.reports.usa %>%
  filter(BankID == 37) %$%
  ur.ers(
    CILoans
  )
```

